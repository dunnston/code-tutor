{
  "id": 73,
  "trackId": 8,
  "language": "python",
  "title": "The Relational Web",
  "subtitle": "Database Relationships & Joins",
  "difficulty": 5,
  "estimatedTime": "50-60 minutes",
  "xpReward": 300,
  "description": "# Master Database Relationships!\n\nðŸ”— **Relationships** connect data across tables for powerful queries.\n\n## Types of Relationships\n\n### One-to-Many (Character â†’ Items)\n```sql\nCREATE TABLE characters (\n    id INTEGER PRIMARY KEY,\n    name TEXT\n);\n\nCREATE TABLE inventory (\n    id INTEGER PRIMARY KEY,\n    character_id INTEGER,\n    item_name TEXT,\n    FOREIGN KEY (character_id) REFERENCES characters(id)\n);\n```\n\n### Many-to-Many (Characters â†” Guilds)\n```sql\nCREATE TABLE characters (...);  \nCREATE TABLE guilds (...);\n\nCREATE TABLE guild_members (\n    character_id INTEGER,\n    guild_id INTEGER,\n    join_date TEXT,\n    PRIMARY KEY (character_id, guild_id),\n    FOREIGN KEY (character_id) REFERENCES characters(id),\n    FOREIGN KEY (guild_id) REFERENCES guilds(id)\n);\n```\n\n## SQL Joins\n\n### INNER JOIN\n```sql\nSELECT characters.name, inventory.item_name\nFROM characters\nINNER JOIN inventory ON characters.id = inventory.character_id;\n```\n\n### LEFT JOIN\n```sql\nSELECT characters.name, inventory.item_name\nFROM characters\nLEFT JOIN inventory ON characters.id = inventory.character_id;\n```\n\n## Your Mission\n\nBuild a guild system with relationships:\n1. **Characters, Guilds, Guild Members tables**\n2. **One-to-many**: Character â†’ Equipment\n3. **Many-to-many**: Characters â†” Guilds\n4. **Complex queries** with joins\n\nâš”ï¸ Master relational database design!\n\n*Hint: Foreign keys maintain data integrity.*",
  "starterCode": "import sqlite3\nfrom typing import List, Optional\nfrom datetime import datetime\n\nclass Database:\n    def __init__(self, db_path='game.db'):\n        self.db_path = db_path\n        self.create_tables()\n    \n    def get_connection(self):\n        return sqlite3.connect(self.db_path)\n    \n    def create_tables(self):\n        conn = self.get_connection()\n        cursor = conn.cursor()\n        \n        # TODO: Create characters table\n        # Fields: id, name, level\n        \n        # TODO: Create guilds table\n        # Fields: id, name, description, created_date\n        \n        # TODO: Create guild_members junction table (many-to-many)\n        # Fields: character_id, guild_id, rank, join_date\n        # PRIMARY KEY (character_id, guild_id)\n        # FOREIGN KEY constraints\n        \n        # TODO: Create equipment table (one-to-many)\n        # Fields: id, character_id, item_name, item_type, equipped\n        # FOREIGN KEY (character_id)\n        \n        conn.commit()\n        conn.close()\n\nclass GuildSystem:\n    def __init__(self, db: Database):\n        self.db = db\n    \n    # TODO: Implement create_character(name, level) -> int\n    # Returns character_id\n    \n    # TODO: Implement create_guild(name, description) -> int\n    # Returns guild_id\n    \n    # TODO: Implement add_member_to_guild(character_id, guild_id, rank='member')\n    # Adds character to guild with rank\n    \n    # TODO: Implement remove_member_from_guild(character_id, guild_id)\n    \n    # TODO: Implement add_equipment(character_id, item_name, item_type, equipped=True)\n    # Adds equipment to character\n    \n    # TODO: Implement get_character_guilds(character_id) -> List[dict]\n    # Returns list of guilds the character belongs to\n    # Use JOIN to get guild details\n    \n    # TODO: Implement get_guild_members(guild_id) -> List[dict]\n    # Returns list of characters in guild with their ranks\n    # Use JOIN to get character details\n    \n    # TODO: Implement get_character_equipment(character_id) -> List[dict]\n    # Returns all equipment for character\n    \n    # TODO: Implement get_equipped_items(character_id) -> List[dict]\n    # Returns only equipped items\n    \n    # TODO: Implement get_guild_roster_with_equipment(guild_id) -> List[dict]\n    # Complex query: Get all guild members with their equipped items\n    # Use multiple JOINs\n\n# ===== TESTS =====\n\nif __name__ == \"__main__\":\n    print(\"Testing Database Relationships...\")\n    \n    db = Database('test_relations.db')\n    guild_sys = GuildSystem(db)\n    \n    # Create characters\n    print(\"\\n=== Creating Characters ===\")\n    hero_id = guild_sys.create_character(\"Aragorn\", 10)\n    mage_id = guild_sys.create_character(\"Gandalf\", 50)\n    rogue_id = guild_sys.create_character(\"Legolas\", 8)\n    print(f\"Created characters: {hero_id}, {mage_id}, {rogue_id}\")\n    \n    # Create guilds\n    print(\"\\n=== Creating Guilds ===\")\n    fellowship_id = guild_sys.create_guild(\"Fellowship\", \"Heroes of Middle Earth\")\n    rangers_id = guild_sys.create_guild(\"Rangers\", \"Guardians of the North\")\n    print(f\"Created guilds: {fellowship_id}, {rangers_id}\")\n    \n    # Add members to guilds\n    print(\"\\n=== Adding Guild Members ===\")\n    guild_sys.add_member_to_guild(hero_id, fellowship_id, \"leader\")\n    guild_sys.add_member_to_guild(mage_id, fellowship_id, \"officer\")\n    guild_sys.add_member_to_guild(rogue_id, fellowship_id, \"member\")\n    guild_sys.add_member_to_guild(hero_id, rangers_id, \"member\")  # Multi-guild!\n    print(\"Members added\")\n    \n    # Add equipment\n    print(\"\\n=== Adding Equipment ===\")\n    guild_sys.add_equipment(hero_id, \"AndÃºril\", \"weapon\", True)\n    guild_sys.add_equipment(hero_id, \"Ranger Cloak\", \"armor\", True)\n    guild_sys.add_equipment(hero_id, \"Rope\", \"tool\", False)\n    guild_sys.add_equipment(mage_id, \"Staff of Power\", \"weapon\", True)\n    guild_sys.add_equipment(rogue_id, \"Elven Bow\", \"weapon\", True)\n    print(\"Equipment added\")\n    \n    # Test queries\n    print(\"\\n=== Character's Guilds ===\")\n    hero_guilds = guild_sys.get_character_guilds(hero_id)\n    print(f\"Aragorn's guilds: {hero_guilds}\")\n    \n    print(\"\\n=== Guild Members ===\")\n    fellowship_members = guild_sys.get_guild_members(fellowship_id)\n    print(f\"Fellowship members: {fellowship_members}\")\n    \n    print(\"\\n=== Character Equipment ===\")\n    hero_equipment = guild_sys.get_character_equipment(hero_id)\n    print(f\"Aragorn's equipment: {hero_equipment}\")\n    \n    print(\"\\n=== Equipped Items Only ===\")\n    hero_equipped = guild_sys.get_equipped_items(hero_id)\n    print(f\"Aragorn's equipped items: {hero_equipped}\")\n    \n    print(\"\\n=== Guild Roster with Equipment ===\")\n    roster = guild_sys.get_guild_roster_with_equipment(fellowship_id)\n    print(f\"Fellowship roster with gear:\")\n    for member in roster:\n        print(f\"  {member}\")\n    \n    print(\"\\nâœ… Database relationships tests complete!\")",
  "solutionCode": "import sqlite3\nfrom typing import List, Optional\nfrom datetime import datetime\n\nclass Database:\n    def __init__(self, db_path='game.db'):\n        self.db_path = db_path\n        self.create_tables()\n    \n    def get_connection(self):\n        return sqlite3.connect(self.db_path)\n    \n    def create_tables(self):\n        conn = self.get_connection()\n        cursor = conn.cursor()\n        \n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS characters (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                name TEXT NOT NULL,\n                level INTEGER DEFAULT 1\n            )\n        ''')\n        \n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS guilds (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                name TEXT NOT NULL UNIQUE,\n                description TEXT,\n                created_date TEXT DEFAULT CURRENT_TIMESTAMP\n            )\n        ''')\n        \n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS guild_members (\n                character_id INTEGER,\n                guild_id INTEGER,\n                rank TEXT DEFAULT 'member',\n                join_date TEXT DEFAULT CURRENT_TIMESTAMP,\n                PRIMARY KEY (character_id, guild_id),\n                FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE,\n                FOREIGN KEY (guild_id) REFERENCES guilds(id) ON DELETE CASCADE\n            )\n        ''')\n        \n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS equipment (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                character_id INTEGER,\n                item_name TEXT NOT NULL,\n                item_type TEXT NOT NULL,\n                equipped INTEGER DEFAULT 1,\n                FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE\n            )\n        ''')\n        \n        conn.commit()\n        conn.close()\n\nclass GuildSystem:\n    def __init__(self, db: Database):\n        self.db = db\n    \n    def create_character(self, name, level) -> int:\n        conn = self.db.get_connection()\n        cursor = conn.cursor()\n        cursor.execute('INSERT INTO characters (name, level) VALUES (?, ?)', (name, level))\n        char_id = cursor.lastrowid\n        conn.commit()\n        conn.close()\n        return char_id\n    \n    def create_guild(self, name, description) -> int:\n        conn = self.db.get_connection()\n        cursor = conn.cursor()\n        cursor.execute('INSERT INTO guilds (name, description) VALUES (?, ?)', (name, description))\n        guild_id = cursor.lastrowid\n        conn.commit()\n        conn.close()\n        return guild_id\n    \n    def add_member_to_guild(self, character_id, guild_id, rank='member'):\n        conn = self.db.get_connection()\n        cursor = conn.cursor()\n        cursor.execute(\n            'INSERT INTO guild_members (character_id, guild_id, rank) VALUES (?, ?, ?)',\n            (character_id, guild_id, rank)\n        )\n        conn.commit()\n        conn.close()\n    \n    def remove_member_from_guild(self, character_id, guild_id):\n        conn = self.db.get_connection()\n        cursor = conn.cursor()\n        cursor.execute(\n            'DELETE FROM guild_members WHERE character_id = ? AND guild_id = ?',\n            (character_id, guild_id)\n        )\n        conn.commit()\n        conn.close()\n    \n    def add_equipment(self, character_id, item_name, item_type, equipped=True):\n        conn = self.db.get_connection()\n        cursor = conn.cursor()\n        cursor.execute(\n            'INSERT INTO equipment (character_id, item_name, item_type, equipped) VALUES (?, ?, ?, ?)',\n            (character_id, item_name, item_type, 1 if equipped else 0)\n        )\n        conn.commit()\n        conn.close()\n    \n    def get_character_guilds(self, character_id) -> List[dict]:\n        conn = self.db.get_connection()\n        conn.row_factory = sqlite3.Row\n        cursor = conn.cursor()\n        cursor.execute('''\n            SELECT g.id, g.name, g.description, gm.rank, gm.join_date\n            FROM guilds g\n            INNER JOIN guild_members gm ON g.id = gm.guild_id\n            WHERE gm.character_id = ?\n        ''', (character_id,))\n        results = [dict(row) for row in cursor.fetchall()]\n        conn.close()\n        return results\n    \n    def get_guild_members(self, guild_id) -> List[dict]:\n        conn = self.db.get_connection()\n        conn.row_factory = sqlite3.Row\n        cursor = conn.cursor()\n        cursor.execute('''\n            SELECT c.id, c.name, c.level, gm.rank, gm.join_date\n            FROM characters c\n            INNER JOIN guild_members gm ON c.id = gm.character_id\n            WHERE gm.guild_id = ?\n        ''', (guild_id,))\n        results = [dict(row) for row in cursor.fetchall()]\n        conn.close()\n        return results\n    \n    def get_character_equipment(self, character_id) -> List[dict]:\n        conn = self.db.get_connection()\n        conn.row_factory = sqlite3.Row\n        cursor = conn.cursor()\n        cursor.execute(\n            'SELECT id, item_name, item_type, equipped FROM equipment WHERE character_id = ?',\n            (character_id,)\n        )\n        results = [dict(row) for row in cursor.fetchall()]\n        conn.close()\n        return results\n    \n    def get_equipped_items(self, character_id) -> List[dict]:\n        conn = self.db.get_connection()\n        conn.row_factory = sqlite3.Row\n        cursor = conn.cursor()\n        cursor.execute(\n            'SELECT id, item_name, item_type FROM equipment WHERE character_id = ? AND equipped = 1',\n            (character_id,)\n        )\n        results = [dict(row) for row in cursor.fetchall()]\n        conn.close()\n        return results\n    \n    def get_guild_roster_with_equipment(self, guild_id) -> List[dict]:\n        conn = self.db.get_connection()\n        conn.row_factory = sqlite3.Row\n        cursor = conn.cursor()\n        cursor.execute('''\n            SELECT \n                c.name as character_name,\n                c.level,\n                gm.rank,\n                e.item_name,\n                e.item_type\n            FROM characters c\n            INNER JOIN guild_members gm ON c.id = gm.character_id\n            LEFT JOIN equipment e ON c.id = e.character_id AND e.equipped = 1\n            WHERE gm.guild_id = ?\n            ORDER BY c.name, e.item_name\n        ''', (guild_id,))\n        results = [dict(row) for row in cursor.fetchall()]\n        conn.close()\n        return results\n\nif __name__ == \"__main__\":\n    print(\"Testing Database Relationships...\")\n    \n    db = Database('test_relations.db')\n    guild_sys = GuildSystem(db)\n    \n    print(\"\\n=== Creating Characters ===\")\n    hero_id = guild_sys.create_character(\"Aragorn\", 10)\n    mage_id = guild_sys.create_character(\"Gandalf\", 50)\n    rogue_id = guild_sys.create_character(\"Legolas\", 8)\n    print(f\"Created characters: {hero_id}, {mage_id}, {rogue_id}\")\n    \n    print(\"\\n=== Creating Guilds ===\")\n    fellowship_id = guild_sys.create_guild(\"Fellowship\", \"Heroes of Middle Earth\")\n    rangers_id = guild_sys.create_guild(\"Rangers\", \"Guardians of the North\")\n    print(f\"Created guilds: {fellowship_id}, {rangers_id}\")\n    \n    print(\"\\n=== Adding Guild Members ===\")\n    guild_sys.add_member_to_guild(hero_id, fellowship_id, \"leader\")\n    guild_sys.add_member_to_guild(mage_id, fellowship_id, \"officer\")\n    guild_sys.add_member_to_guild(rogue_id, fellowship_id, \"member\")\n    guild_sys.add_member_to_guild(hero_id, rangers_id, \"member\")\n    print(\"Members added\")\n    \n    print(\"\\n=== Adding Equipment ===\")\n    guild_sys.add_equipment(hero_id, \"AndÃºril\", \"weapon\", True)\n    guild_sys.add_equipment(hero_id, \"Ranger Cloak\", \"armor\", True)\n    guild_sys.add_equipment(hero_id, \"Rope\", \"tool\", False)\n    guild_sys.add_equipment(mage_id, \"Staff of Power\", \"weapon\", True)\n    guild_sys.add_equipment(rogue_id, \"Elven Bow\", \"weapon\", True)\n    print(\"Equipment added\")\n    \n    print(\"\\n=== Character's Guilds ===\")\n    hero_guilds = guild_sys.get_character_guilds(hero_id)\n    print(f\"Aragorn's guilds: {hero_guilds}\")\n    \n    print(\"\\n=== Guild Members ===\")\n    fellowship_members = guild_sys.get_guild_members(fellowship_id)\n    print(f\"Fellowship members: {fellowship_members}\")\n    \n    print(\"\\n=== Character Equipment ===\")\n    hero_equipment = guild_sys.get_character_equipment(hero_id)\n    print(f\"Aragorn's equipment: {hero_equipment}\")\n    \n    print(\"\\n=== Equipped Items Only ===\")\n    hero_equipped = guild_sys.get_equipped_items(hero_id)\n    print(f\"Aragorn's equipped items: {hero_equipped}\")\n    \n    print(\"\\n=== Guild Roster with Equipment ===\")\n    roster = guild_sys.get_guild_roster_with_equipment(fellowship_id)\n    print(f\"Fellowship roster with gear:\")\n    for member in roster:\n        print(f\"  {member}\")\n    \n    print(\"\\nâœ… Database relationships tests complete!\")",
  "hints": [
    "Foreign keys link tables: FOREIGN KEY (character_id) REFERENCES characters(id)",
    "Junction tables for many-to-many use composite primary key: PRIMARY KEY (char_id, guild_id)",
    "INNER JOIN returns only matching rows. LEFT JOIN includes all from left table.",
    "Use conn.row_factory = sqlite3.Row to get results as dictionaries.",
    "ON DELETE CASCADE automatically removes related rows when parent is deleted."
  ],
  "validationTests": [
    {
      "type": "code_contains",
      "value": "CREATE TABLE IF NOT EXISTS guild_members",
      "description": "Must create junction table for many-to-many"
    },
    {
      "type": "code_contains",
      "value": "FOREIGN KEY",
      "description": "Must use foreign key constraints"
    },
    {
      "type": "code_contains",
      "value": "INNER JOIN",
      "description": "Must use INNER JOIN for queries"
    },
    {
      "type": "code_contains",
      "value": "LEFT JOIN",
      "description": "Must use LEFT JOIN for optional relationships"
    },
    {
      "type": "output_contains",
      "value": "Database relationships tests complete",
      "description": "Tests should complete"
    }
  ],
  "learningObjectives": [
    "Design one-to-many relationships",
    "Implement many-to-many with junction tables",
    "Use foreign keys for data integrity",
    "Write INNER and LEFT JOIN queries",
    "Query across multiple related tables",
    "Understand CASCADE operations"
  ],
  "nextLessonId": 74,
  "previousLessonId": 72,
  "tags": ["advanced", "database", "sql", "relationships", "joins", "foreign-keys"],
  "commonMistakes": [
    {
      "mistake": "Forgetting foreign key constraints",
      "explanation": "Always add FOREIGN KEY constraints to maintain referential integrity."
    },
    {
      "mistake": "Using INNER JOIN when LEFT JOIN needed",
      "explanation": "INNER JOIN excludes rows without matches. Use LEFT JOIN to include all from left table."
    },
    {
      "mistake": "Not using junction tables for many-to-many",
      "explanation": "Many-to-many requires a junction/bridge table with foreign keys to both tables."
    }
  ]
}
